{"version":3,"file":"index.js","mappings":"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","sources":["webpack://vootv-api/./src/app.config.ts","webpack://vootv-api/./src/controllers/user.ts","webpack://vootv-api/./src/index.ts","webpack://vootv-api/./src/middlewares/auth.ts","webpack://vootv-api/./src/routes/user.ts","webpack://vootv-api/./src/util/db.connection.ts","webpack://vootv-api/./src/util/env.ts","webpack://vootv-api/./src/util/requestHandler.config.ts","webpack://vootv-api/external commonjs \"@prisma/client\"","webpack://vootv-api/external commonjs \"bcryptjs\"","webpack://vootv-api/external commonjs \"cookie-parser\"","webpack://vootv-api/external commonjs \"cors\"","webpack://vootv-api/external commonjs \"dotenv/config\"","webpack://vootv-api/external commonjs \"envalid\"","webpack://vootv-api/external commonjs \"express\"","webpack://vootv-api/external commonjs \"helmet\"","webpack://vootv-api/external commonjs \"http-errors\"","webpack://vootv-api/external commonjs \"jsonwebtoken\"","webpack://vootv-api/external commonjs \"morgan\"","webpack://vootv-api/webpack/bootstrap","webpack://vootv-api/webpack/startup"],"sourcesContent":["import \"dotenv/config\"\r\nimport express, { Request, Response, NextFunction } from \"express\"\r\nimport morgan from \"morgan\"\r\nimport cors from \"cors\"\r\nimport helmet from \"helmet\"\r\nimport cookieParser from \"cookie-parser\"\r\nimport createHttpError, { isHttpError } from \"http-errors\"\r\nimport userRoutes from \"./routes/user\"\r\nimport env from \"./util/env\"\r\n\r\nconst homeMessage = `\r\n<div style=\"display: flex; align-items: center; justify-content: center; height: 90vh\"> \r\n<h1 style=\"font-size: 72px; background: -webkit-linear-gradient(45deg, #09009f, #00ff95 80%); -webkit-background-clip: text;\r\n-webkit-text-fill-color: transparent;\">SYNAPSE REST API</h1>\r\n</div>\r\n`\r\n\r\nconst app = express()\r\n\r\napp.use(helmet())\r\n\r\napp.use(morgan(\"dev\"))\r\n\r\napp.use(cors({ origin: [env.CLIENT_URL], credentials: true }))\r\n\r\napp.use(cookieParser(env.COOKIE_SECRET))\r\n\r\napp.use(express.json())\r\n\r\napp.use(express.urlencoded({ extended: true }))\r\n\r\napp.get(\"/\", (req, res) => res.status(200).send(homeMessage))\r\n\r\napp.use(\"/user\", userRoutes)\r\n\r\n//Not found\r\napp.use((req, res, next) => next(createHttpError(404, \"Endpoint not found\")))\r\n\r\n//Error Middleware\r\n// eslint-disable-next-line @typescript-eslint/no-unused-vars\r\napp.use((error: unknown, req: Request, res: Response, next: NextFunction) => {\r\n  console.error(error)\r\n  let errorMessage = \"An unknown error occurred\"\r\n  let statusCode = 500\r\n  //Todo Handle prisma invalid id error\r\n  if (isHttpError(error)) {\r\n    statusCode = error.status\r\n    errorMessage = error.message\r\n  }\r\n  res.status(statusCode).json(errorMessage)\r\n})\r\n\r\nexport default app\r\n","import express, { Request } from \"express\"\r\nimport { Controller } from \"../util/requestHandler.config\"\r\nimport { hash, compare } from \"bcryptjs\"\r\nimport createHttpError from \"http-errors\"\r\nimport crypto from \"crypto\"\r\nimport prisma from \"../util/db.connection\"\r\n\r\ninterface UserSchema {\r\n  email: string\r\n  fullName: string\r\n  password: string\r\n  skillName: string\r\n  skillLevel: string\r\n}\r\n\r\ntype Login = Pick<UserSchema, \"email\" | \"password\">\r\n\r\nexport default Controller({\r\n  async register(req: Request<{}, {}, UserSchema>, res) {\r\n    const { email, password, skillName, skillLevel } = req.body\r\n\r\n    const exists = await prisma.user.findFirst({ where: { email } })\r\n\r\n    if (exists) throw createHttpError(403, \"Account already exists, please login\")\r\n\r\n    const hashedPW = await hash(password, 10)\r\n\r\n    //* Add role of user by default\r\n    const user = await prisma.user.create({ data: { ...req.body, password: hashedPW } })\r\n\r\n    const { email: _email, id } = user\r\n\r\n    return res.status(200).json({ message: \"Sign up successful\", userId: id })\r\n  },\r\n\r\n  async logout(req, res) {\r\n    await req.logout()\r\n\r\n    res.status(200).send(\"Logout successful\")\r\n  },\r\n\r\n  // async verifyEmail(req: Request<{}, {}, Verify>, res) {\r\n  //   const { code } = req.body\r\n\r\n  //   const { id } = req.user\r\n\r\n  //   const codeExists = await prisma.verficationCode.findUnique({\r\n  //     where: { userId_action: { userId: id, action: \"EMAIL_VERIFICATION\" } },\r\n  //   })\r\n\r\n  //   if (!codeExists) throw createHttpError(403, \"Code expired, request new code\")\r\n\r\n  //   if (codeExists.code !== code) throw createHttpError(403, \"Invalid code, retry\")\r\n\r\n  //   await prisma.user.update({\r\n  //     where: { id },\r\n  //     data: { emailVerified: true },\r\n  //   })\r\n\r\n  //   await prisma.verficationCode.delete({ where: { id: codeExists.id } })\r\n\r\n  //   return res.status(200).send(\"Email verification successful\")\r\n  // },\r\n\r\n  //TODO Implement resending verification email flow\r\n  async resendVerificationCode(req, res) {\r\n    return res.status(200).json(\"Okay\")\r\n  },\r\n\r\n  // async login(req: Request<{}, {}, Login, { admin: string }>, res) {\r\n  //   const { email, password } = req.body\r\n\r\n  //   const { admin } = req.query\r\n\r\n  //   const user = await prisma.user.findUnique({ where: { email } })\r\n\r\n  //   if (!user) throw createHttpError(403, \"Invalid email or password\")\r\n\r\n  //   if (admin == \"true\" && user.role != \"ADMIN\") throw createHttpError(403, \"Unknown Error Occured\")\r\n\r\n  //   const validPassword = await compare(password, user.password)\r\n\r\n  //   if (!validPassword) throw createHttpError(403, \"Invalid email or password\")\r\n\r\n  //   if (!user.emailVerified) throw createHttpError(403, \"Please verify your email\")\r\n\r\n  //   const twoWeeks = new Date(new Date().getTime() + 14 * 24 * 60 * 60 * 1000)\r\n\r\n  //   const { password: _, emailVerified, role, updatedAt, ...rest } = user\r\n\r\n  //   return res\r\n  //     .cookie(\"session.token\", \"Token from JWT\", {\r\n  //       signed: true,\r\n  //       maxAge: 1000 * 60 * 60 * 24 * 14,\r\n  //       sameSite: \"none\",\r\n  //       secure: true,\r\n  //     })\r\n  //     .status(200)\r\n  //     .send(\"Login successful\")\r\n  // },\r\n\r\n  // async sendPasswordResetMail(req: Request<{}, {}, ResetPasswordMail>, res) {\r\n  //   const { email } = req.body\r\n\r\n  //   const user = await prisma.user.findUnique({ where: { email } })\r\n\r\n  //   if (!user) throw createHttpError(403, \"User not found\")\r\n\r\n  //   const rand = crypto.randomInt(1000, 9999).toString()\r\n\r\n  //   const otp = await prisma.verficationCode.create({\r\n  //     data: {\r\n  //       userId: user.id,\r\n  //       code: rand,\r\n  //       action: \"PASSWORD_RESET\",\r\n  //     },\r\n  //   })\r\n\r\n  //   if (!otp) throw createHttpError(403, \"Could not create verification code\")\r\n\r\n  //   return res.status(200).json(\"Password reset code sent to your mail\")\r\n  // },\r\n\r\n  // async verifyPasswordResetCode(req: Request<{}, {}, Verify>, res) {\r\n  //   const { code, userId } = req.body\r\n\r\n  //   const otp = await prisma.verficationCode.findFirst({\r\n  //     where: { code, userId, action: \"PASSWORD_RESET\" },\r\n  //   })\r\n\r\n  //   if (!otp) throw createHttpError(403, \"Code expired, request new code\")\r\n\r\n  //   if (code !== otp.code) throw createHttpError(403, \"Invalid code, try again\")\r\n\r\n  //   return res.status(200).json(\"Verified\")\r\n  // },\r\n\r\n  // async changePassword(req: Request<{}, {}, ChangePassword>, res) {\r\n  //   const { password } = req.body\r\n\r\n  //   const { id } = req.user\r\n\r\n  //   const hashedPW = await hash(password, 10)\r\n\r\n  //   await prisma.user.update({ where: { id }, data: { password: hashedPW } })\r\n\r\n  //   return res.status(200).json(\"Password changed\")\r\n  // },\r\n\r\n  // async updateAccount(req: Request<{}, {}, UserSchema>, res) {\r\n  //   const { id } = req.user\r\n\r\n  //   let data = req.body\r\n\r\n  //   await prisma.user.update({ where: { id }, data })\r\n\r\n  //   return res.status(200).json(\"Account details updated\")\r\n  // },\r\n})\r\n","import app from './app.config';\r\nimport env from './util/env';\r\n\r\nconst PORT = env.PORT;\r\n\r\napp.listen(PORT, () => console.log('Listening on PORT ' + PORT));\r\n","import createHttpError from \"http-errors\"\r\nimport prisma from \"../util/db.connection\"\r\nimport { asyncWrapper, Controller } from \"../util/requestHandler.config\"\r\nimport { Request } from \"express\"\r\nimport jwt from \"jsonwebtoken\"\r\nimport env from \"../util/env\"\r\n\r\nconst logout = asyncWrapper(async (req, res, next) => {\r\n  req.logout = async () => {\r\n    res.clearCookie(\"session.token\", {\r\n      signed: true,\r\n      sameSite: \"none\",\r\n      secure: true,\r\n    })\r\n    return true\r\n  }\r\n  next()\r\n})\r\n\r\ntype ID = { userId: string }\r\n\r\ntype MiddlewareRequest = Request<ID, {}, ID>\r\n\r\n/**Checks request body or params and verifies user */\r\nconst verifyUser = asyncWrapper(async (req: MiddlewareRequest, res, next) => {\r\n  const userId = req.body.userId || req.params.userId\r\n\r\n  if (!userId) throw createHttpError(403, \"Invalid ID\")\r\n\r\n  const user = await prisma.user.findUnique({ where: { id: userId } })\r\n\r\n  if (!user) throw createHttpError(404, \"User not found\")\r\n\r\n  req.user = user\r\n\r\n  next()\r\n})\r\n\r\n/**Authenticates user or admin through headers in request or cookie for admin */\r\nconst authenticate = Controller({\r\n  async user(req, res, next) {\r\n    const token = req.cookies.jwt\r\n    if (!token) throw createHttpError(401, \"Unauthorized - No token provided\")\r\n\r\n    const decoded = jwt.verify(token, env.JWT_SECRET)\r\n\r\n    if (!decoded) throw createHttpError(401, \"Session expired\")\r\n\r\n    const user = await prisma.user.findUnique({ where: { id: decoded as string } })\r\n\r\n    if (!user) throw createHttpError(404, \"User not found\")\r\n\r\n    req.user = user\r\n\r\n    next()\r\n  },\r\n})\r\n\r\nexport { verifyUser, authenticate, logout }\r\n","import { Router } from \"express\"\r\nimport controller from \"../controllers/user\"\r\nimport { authenticate, verifyUser, logout } from \"../middlewares/auth\"\r\n\r\nconst { user } = authenticate\r\n\r\nconst router = Router()\r\n\r\nrouter.use(logout)\r\n\r\nrouter.post(\"/register\", controller.register)\r\n\r\n// router.get(\"/auth\", authenticate.admin)\r\n\r\n// router.get(\"/:id\", admin, controller.getUser)\r\n\r\n// router.post(\"/login\", controller.login)\r\n\r\n// router.patch(\"/account-info\", user, upload.single(\"avi\"), controller.updateAccount)\r\n\r\n// router.post(\"/password-reset-mail\", controller.sendPasswordResetMail)\r\n\r\n// router.post(\"/verify-password-reset\", controller.verifyPasswordResetCode)\r\n\r\n// router.put(\"/reset-password\", verifyUser, controller.changePassword)\r\n\r\n// router.post(\"/verify-email\", verifyUser, controller.verifyEmail)\r\n\r\n// router.get('/resend-email-verify-code', controller.resendVerificationCode);\r\n\r\nrouter.post(\"/logout\", controller.logout)\r\n\r\nexport default router\r\n","import { PrismaClient } from \"@prisma/client\"\r\n\r\nlet prisma: PrismaClient\r\n\r\ndeclare global {\r\n  var __prisma: PrismaClient | undefined\r\n}\r\n\r\nif (!global.__prisma) {\r\n  global.__prisma = new PrismaClient()\r\n}\r\n\r\nprisma = global.__prisma\r\n\r\nexport default prisma\r\n","import { cleanEnv, port, str } from \"envalid\"\r\n\r\nexport default cleanEnv(process.env, {\r\n  PORT: port(),\r\n  JWT_SECRET: str(),\r\n  DATABASE_URL: str(),\r\n  COOKIE_SECRET: str(),\r\n  CLIENT_URL: str(),\r\n})\r\n","import {Request, Response, NextFunction} from 'express';\r\n\r\nexport type CustomRequestHandler<T = any> = (\r\n  req: Request,\r\n  res: Response,\r\n  next?: NextFunction,\r\n  ...rest: T[]\r\n) => Promise<void | Response>;\r\n\r\nexport const asyncWrapper = (fn: CustomRequestHandler) => {\r\n  return async (req: Request, res: Response, next: NextFunction) => {\r\n    try {\r\n      await fn(req, res, next);\r\n    } catch (error) {\r\n      next(error);\r\n    }\r\n  };\r\n};\r\n\r\n/* Request params, {}, Request body, Request query */\r\n\r\nexport const Controller = <T extends {[K in keyof T]: CustomRequestHandler}>(\r\n  controllers: T\r\n) => {\r\n  for (let key of Object.keys(controllers)) {\r\n    controllers[key] = asyncWrapper(controllers[key]);\r\n  }\r\n  return controllers;\r\n};\r\n","module.exports = require(\"@prisma/client\");","module.exports = require(\"bcryptjs\");","module.exports = require(\"cookie-parser\");","module.exports = require(\"cors\");","module.exports = require(\"dotenv/config\");","module.exports = require(\"envalid\");","module.exports = require(\"express\");","module.exports = require(\"helmet\");","module.exports = require(\"http-errors\");","module.exports = require(\"jsonwebtoken\");","module.exports = require(\"morgan\");","// The module cache\nvar __webpack_module_cache__ = {};\n\n// The require function\nfunction __webpack_require__(moduleId) {\n\t// Check if module is in cache\n\tvar cachedModule = __webpack_module_cache__[moduleId];\n\tif (cachedModule !== undefined) {\n\t\treturn cachedModule.exports;\n\t}\n\t// Create a new module (and put it into the cache)\n\tvar module = __webpack_module_cache__[moduleId] = {\n\t\t// no module.id needed\n\t\t// no module.loaded needed\n\t\texports: {}\n\t};\n\n\t// Execute the module function\n\t__webpack_modules__[moduleId].call(module.exports, module, module.exports, __webpack_require__);\n\n\t// Return the exports of the module\n\treturn module.exports;\n}\n\n","// startup\n// Load entry module and return exports\n// This entry module is referenced by other modules so it can't be inlined\nvar __webpack_exports__ = __webpack_require__(156);\n"],"names":["app","use","origin","CLIENT_URL","credentials","COOKIE_SECRET","json","urlencoded","extended","get","req","res","status","send","next","error","console","errorMessage","statusCode","isHttpError","message","Controller","register","email","password","skillName","skillLevel","body","user","findFirst","where","hashedPW","hash","create","data","_email","id","userId","logout","resendVerificationCode","PORT","listen","log","asyncWrapper","clearCookie","signed","sameSite","secure","verifyUser","params","findUnique","authenticate","token","cookies","jwt","decoded","verify","JWT_SECRET","router","Router","post","prisma","global","__prisma","PrismaClient","cleanEnv","process","env","port","str","DATABASE_URL","fn","controllers","key","Object","keys","module","exports","require","__webpack_module_cache__","__webpack_require__","moduleId","cachedModule","undefined","__webpack_modules__","call"],"sourceRoot":""}